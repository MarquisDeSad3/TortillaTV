<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
  <title>TortillaTV — Smart Duo</title>
  <meta name="theme-color" content="#0b1324" />

  <!-- Fuentes y Tailwind -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@800&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ["Inter","system-ui","Segoe UI","Roboto"], display: ["Caveat","ui-serif"] },
          colors: { paper: "#faf9f6", rule: "#93c5fd66", marginRed: "#ef4444aa" },
          keyframes: { pageFlipIn: { "0%": { transform:"rotateY(-90deg) translateX(-20px)", opacity:0 }, "100%": { transform:"rotateY(0) translateX(0)", opacity:1 } } },
          animation: { pageFlipIn: "pageFlipIn .6s ease both" },
          boxShadow: { card: "0 12px 30px rgba(0,0,0,.07)" }
        }
      }
    }
  </script>

  <!-- Firebase (compat) SOLO login Google -->
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>

  <style>
    :root{ --paper:#faf9f6; --rule:#93c5fd66; --margin:#ef4444aa; --hole:#e5e7eb; --ink:#111827; }
    html,body{ height:100%; background:var(--paper); color:var(--ink); -webkit-font-smoothing:antialiased; }

    /* Papel y adornos (estética) */
    .paper-bg{ position:relative; min-height:100vh; background-image:repeating-linear-gradient(0deg, transparent, transparent 32px, var(--rule) 33px, var(--rule) 34px); }
    .paper-bg::before{ content:""; position:absolute; inset:0; background:linear-gradient(90deg, transparent 56px, var(--margin) 59px, transparent 62px); pointer-events:none }
    .paper-holes{ position:absolute; left:18px; top:96px; display:flex; flex-direction:column; gap:96px; pointer-events:none }
    .paper-hole{ width:18px; height:18px; border-radius:999px; background:var(--hole); box-shadow:inset 0 2px 4px rgba(0,0,0,.2) }
    .book{ perspective:1200px }
    .page{ transform-origin:left center; backface-visibility:hidden; transform-style:preserve-3d; transition:opacity .4s ease }
    .page.hidden{ opacity:0; pointer-events:none; transform:rotateY(-90deg) translateX(-20px) }
    .page.visible{ opacity:1; transform:rotateY(0); animation:pageFlipIn .6s ease both }
    .card{ background:rgba(255,255,255,.8); border:2px solid rgba(17,24,39,.1); border-radius:20px; padding:12px; box-shadow:0 12px 30px rgba(0,0,0,.07); backdrop-filter:blur(6px) }

    .hero{ position:relative; min-height:78vh; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center }
    .ttv{ position:relative; display:inline-block }
    .ttv .word{ display:inline-block; transform-origin:50% 70%; animation:ttv-wobble 2.4s ease-in-out infinite }
    .ttv .word:nth-child(2){ animation-delay:.15s }
    .ttv .word:nth-child(3){ animation-delay:.3s }
    .ttv .accent{ display:inline-block; padding-inline:.15em; transform:rotate(-2deg); text-shadow:0 2px 0 #ffe4e6 }
    @keyframes ttv-wobble{ 0%,100%{ transform:translateY(0) rotate(0) } 25%{ transform:translateY(-4px) rotate(-1.2deg) } 50%{ transform:translateY(2px) rotate(.8deg) } 75%{ transform:translateY(-2px) rotate(-.6deg) } }

    .scribble{ width:min(920px,92vw); height:32px; margin-inline:auto }
    .scribble path{ stroke:rgba(239,68,68,.7); stroke-width:6; fill:none; stroke-linecap:round; stroke-dasharray:1400; animation:scribble 2s ease forwards }

    .corner{ position:absolute; right:min(2rem,5vw); top:clamp(10px,4vh,40px); display:flex; gap:.5rem; align-items:center; z-index:10 }
    .corner .note{ font-family:"Caveat", ui-serif; font-weight:800; font-size:clamp(18px,3.8vw,34px); background:#fff7cc; color:#0b1324; padding:.15em .45em; border-radius:.5rem; box-shadow:0 4px 0 rgba(0,0,0,.2); transform:rotate(-2.5deg) }
    .marquee{ position:relative; width:min(42ch,70vw); overflow:hidden; border-radius:.5rem; border:2px dashed rgba(17,24,39,.2); background:rgba(255,255,255,.75) }
    .marquee ul{ display:flex; gap:2.5rem; white-space:nowrap; padding:.35rem .75rem; animation:marquee-scroll 14s linear infinite }
    .marquee li{ list-style:none; font-family:"Caveat"; font-size:clamp(16px,3.2vw,30px); font-weight:800; color:#111827 }
    @keyframes marquee-scroll{ 0%{ transform:translateX(0) } 100%{ transform:translateX(-50%) } }

    /* ====== VIDEO ====== */
    video{ width:100%; height:100%; object-fit:cover; background:#0b1324; display:block; }
    video.mirror{ transform: scaleX(-1) }

    .stage{ position:relative; width:100%; }
    .stage .tile{ position:relative; border-radius:16px; overflow:hidden; background:#000; }

    /* 50/50 (PC): tamaño del cuadro constante; ajustamos object-fit dinámico por JS */
    .layout-split{ display:grid; grid-template-columns:1fr 1fr; gap:1rem; }
    .layout-split .tile{ aspect-ratio:16/9; } /* el JS podrá cambiar este ratio según el track */

    /* Duo: remoto pantalla completa; tú en PiP */
    .layout-duo{ position:relative; }
    .layout-duo .remote{ width:100%; height:var(--vh, 70vh); aspect-ratio:auto; border-radius:0; }
    .layout-duo .local{ display:none !important; } /* evita duplicación en grande */
    .layout-duo .pip{ display:block !important; }

    .pip{
      position:absolute; right:12px; bottom:12px;
      width:min(28%, 220px); aspect-ratio:16/9;
      border-radius:12px; overflow:hidden;
      border:3px solid #fff; box-shadow:0 8px 24px rgba(0,0,0,.35);
      background:#0b1324; touch-action:none; cursor:grab;
    }
    .pip.dragging{ cursor:grabbing; }

    /* Topbar (PC) */
    .topbar .btn{ border:2px solid rgba(17,24,39,.3); background:rgba(255,255,255,.9); padding:.5rem .9rem; border-radius:999px; font-weight:600; }
    .topbar .btn:disabled{ opacity:.55 }

    /* Botón único (MÓVIL) */
    .mobile-fab{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:calc(env(safe-area-inset-bottom,0) + 16px);
      z-index:60;
      border-radius:999px; padding:.9rem 1.25rem;
      border:2px solid rgba(17,24,39,.2);
      background:#fff; font-weight:700; box-shadow:0 10px 28px rgba(0,0,0,.22);
    }

    /* Overlay sala de espera */
    .overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.25); z-index:50 }
    .overlay.show{ display:flex }
    .dot{ width:10px; height:10px; border-radius:999px; background:#ef4444; margin:0 4px; animation:b .9s infinite alternate }
    .dot:nth-child(2){ animation-delay:.15s } .dot:nth-child(3){ animation-delay:.3s }
    @keyframes b{ from{ transform:translateY(0); opacity:.5 } to{ transform:translateY(-6px); opacity:1 } }

    /* Helpers PC */
    .full-bleed{ width:100vw; position:relative; left:50%; right:50%; margin-left:-50vw; margin-right:-50vw; }
    @media (min-width: 640px){
      #videoShell{ height: var(--vh, 70vh); }
      .card.stretch{ height:100%; display:flex; flex-direction:column; }
      .card.stretch > .tile{ flex:1 1 auto; }
    }

    /* MÓVIL: siempre Duo + un solo botón */
    @media (max-width: 640px){
      .layout-split{ display:block; }
      .topbar{ display:none; }
      .layout-duo .remote{ width:100vw; height:calc(100vh - 80px); aspect-ratio:auto; border-radius:0; }
      .pip{ right:10px; bottom:86px; width:34vw; }
      .book{ padding:0 !important; }
      .hero{ min-height:72vh }
      .marquee{ width:min(34ch,88vw) }
      .full-bleed{ margin:0; left:0; right:0; width:100%; }
      main{ padding:0 !important; }
    }
  </style>
</head>
<body class="font-sans">
  <div class="paper-bg">
    <div class="paper-holes"><div class="paper-hole"></div><div class="paper-hole"></div><div class="paper-hole"></div></div>

    <main class="book mx-auto max-w-5xl px-6 py-10">
      <!-- LANDING -->
      <section id="page-landing" class="page visible">
        <div class="hero">
          <div class="corner">
            <span class="note">anal</span>
            <div class="marquee"><ul id="cornerMessages"></ul></div>
          </div>

          <h1 class="font-display font-extrabold select-none ttv" style="font-size:clamp(56px,10vw,140px); line-height:.9; text-shadow:0 1px 0 #fff, 0 10px 18px rgba(0,0,0,.15)">
            <span class="word">Tortilla</span><span class="accent text-rose-600">TV</span>
          </h1>
          <p class="mt-4 text-neutral-700 text-lg">Video chat aleatorio</p>

          <!-- Género -->
          <div class="mt-6 grid grid-cols-3 gap-3 max-w-md">
            <button data-gen="Hombre" class="gen card py-4 flex flex-col items-center gap-2"><span class="font-semibold">Hombre</span></button>
            <button data-gen="Mujer"  class="gen card py-4 flex flex-col items-center gap-2"><span class="font-semibold">Mujer</span></button>
            <button data-gen="Lada"   class="gen card py-4 flex flex-col items-center gap-2"><span class="font-semibold">Lada</span></button>
          </div>
          <p id="genElegido" class="mt-2 text-sm text-neutral-600"></p>

          <!-- Google login -->
          <button id="btn-google" class="mt-6 rounded-xl border-2 border-neutral-900/40 bg-white/90 px-7 py-3.5 font-semibold shadow disabled:opacity-50" disabled>
            Iniciar con Google
          </button>

          <svg class="scribble mt-6" viewBox="0 0 1200 100" preserveAspectRatio="none" aria-hidden="true">
            <path d="M10,70 C200,20 400,120 600,60 C800,0 1000,120 1190,50"/>
          </svg>
        </div>
      </section>

      <!-- SALA -->
      <section id="page-chat" class="page hidden">
        <!-- Topbar PC -->
        <div class="card p-3 mb-4 topbar">
          <div class="flex flex-wrap items-center gap-2">
            <button id="btn-start" class="btn">Buscar</button>
            <button id="btn-next"  class="btn" disabled>Siguiente</button>
            <button id="btn-stop"  class="btn" disabled>Detener</button>

            <div class="ml-auto flex items-center gap-2">
              <button id="btn-layout" class="btn hidden sm:inline-flex">Vista: 50/50</button>
              <button id="btn-expand" class="btn hidden sm:inline-flex">Pantalla</button>
              <button id="btn-fit"    class="btn hidden sm:inline-flex">Ajuste: auto</button>
              <button id="btn-duo"    class="btn hidden sm:inline-flex">Vista: Duo</button>
            </div>

            <div class="flex items-center gap-2 text-sm w-full">
              <span id="status" class="text-neutral-700">Listo</span>
              <span id="peerLabel" class="text-neutral-700 hidden">Pareja: —</span>
              <span id="you-badge" class="ml-auto text-xs px-2 py-1 rounded-full border border-black/20 bg-white/70 hidden">Tú: —</span>
            </div>
          </div>
        </div>

        <!-- Video -->
        <div id="videoShell" class="full-bleed">
          <div id="stage" class="stage layout-split">
            <!-- Remoto -->
            <div class="tile remote" id="remoteTile">
              <video id="remoteVideo" autoplay playsinline></video>
            </div>
            <!-- Local (solo visible en split) -->
            <div class="tile local" id="localTile">
              <video id="localVideo" autoplay playsinline muted class="mirror"></video>
            </div>
            <!-- PiP -->
            <div id="pip" class="pip" style="display:none;">
              <video id="pipVideo" autoplay playsinline muted></video>
            </div>
          </div>
        </div>

        <!-- Móvil: botón único -->
        <button id="mobileFab" class="mobile-fab sm:hidden">Iniciar videochat</button>

        <div class="mt-6 flex items-center justify-center">
          <button id="btn-salir-chat" class="rounded-full border-2 border-neutral-900/30 bg-white/80 px-5 py-2 text-sm font-semibold shadow">Salir</button>
        </div>
      </section>
    </main>
  </div>

  <!-- Overlay sala de espera -->
  <div id="overlay" class="overlay">
    <div class="card px-5 py-4 flex items-center gap-3 bg-white">
      <span class="font-semibold">Buscando pareja…</span>
      <div class="flex"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
    </div>
  </div>

  <!-- SCRIPTS -->
  <script>
    /* ===== WS dinámico + override ?ws= ===== */
    (function(){
      const p = new URLSearchParams(location.search);
      const wsOverride = p.get('ws');
      window.WS_SIGNALLING_URL = wsOverride || ((location.protocol === 'https:') ? `wss://${location.host}` : `ws://${location.host}`);
      console.log("WS =", window.WS_SIGNALLING_URL);
    })();

    /* ===== Firebase Auth (Google) ===== */
    const firebaseConfig = {
      apiKey: "AIzaSyBVuvV7NOaqkN6arT3xPTBdxMZg7TTPhlM",
      authDomain: "tortillatv-bf0c6.firebaseapp.com",
      projectId: "tortillatv-bf0c6",
      storageBucket: "tortillatv-bf0c6.firebasestorage.app",
      messagingSenderId: "193994912181",
      appId: "1:193994912181:web:03464c47f30fc5ac4d69fc"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    /* ===== Helpers UI ===== */
    const pages = { landing: qs('#page-landing'), chat: qs('#page-chat') };
    function qs(s,root=document){ return root.querySelector(s) }
    function show(k){ Object.values(pages).forEach(p=>{p.classList.add('hidden');p.classList.remove('visible')}); pages[k].classList.remove('hidden'); pages[k].classList.add('visible'); window.scrollTo({top:0,behavior:'smooth'}) }
    function setStatus(t){ const el=qs('#status'); if(el) el.textContent=t }

    const overlay   = qs('#overlay');
    const peerLabel = qs('#peerLabel');
    const youBadge  = qs('#you-badge');
    const mobileFab = qs('#mobileFab');

    // Hero marquee
    const MESSAGES=['Kristoff','Astroboy','A ochoa lo mataron a balazos'];
    (function(){
      const ul = document.getElementById('cornerMessages');
      if(!ul) return;
      const arr=[...MESSAGES,...MESSAGES];
      ul.innerHTML = arr.map(m=>`<li>${m}</li>`).join('');
      setInterval(()=>{ document.querySelectorAll('.ttv .word, .ttv .accent').forEach(el=>{ el.style.animationDelay=(Math.random()*0.6).toFixed(2)+'s'; }); }, 3000);
    })();

    /* ===== Estado landing + auth ===== */
    let chosenGender=null;
    const genButtons=[...document.querySelectorAll('.gen')];
    const genElegido=qs('#genElegido');
    const btnGoogle=qs('#btn-google');

    genButtons.forEach(b=>{
      b.addEventListener('click', ()=>{
        genButtons.forEach(x=>x.classList.remove('ring','ring-rose-400'));
        b.classList.add('ring','ring-rose-400');
        chosenGender=b.getAttribute('data-gen');
        genElegido.textContent='Has elegido: '+chosenGender;
        btnGoogle.disabled=false;
      });
    });

    let currentUser=null;
    auth.onAuthStateChanged((u)=>{
      currentUser=u||null;
      if(!u){ show('landing'); youBadge.classList.add('hidden'); return; }
      youBadge.classList.remove('hidden');
      youBadge.textContent=`Tú: ${u.displayName||'—'} · ${chosenGender||'—'}`;
      show('chat');
      initLayoutForDevice();
      fitVH();
    });

    btnGoogle?.addEventListener('click', async ()=>{
      if(!chosenGender){ alert('Elige tu género primero'); return; }
      try{
        const provider=new firebase.auth.GoogleAuthProvider();
        await auth.signInWithPopup(provider);
        localStorage.setItem('ttv_gender', chosenGender);
      }catch(e){ alert('Error Google: '+e.message); }
    });

    /* ===== Señalización + WebRTC ===== */
    const btnStart=qs('#btn-start'), btnNext=qs('#btn-next'), btnStop=qs('#btn-stop'), btnSalirChat=qs('#btn-salir-chat');
    const btnLayout=qs('#btn-layout'), btnExpand=qs('#btn-expand'), btnFit=qs('#btn-fit'), btnDuo=qs('#btn-duo');

    const localVideo=qs('#localVideo'), remoteVideo=qs('#remoteVideo'), pip=qs('#pip'), pipVideo=qs('#pipVideo');
    const stage=qs('#stage'), videoShell=qs('#videoShell'), remoteTile=qs('#remoteTile'), localTile=qs('#localTile');

    // Estado
    let ws=null, wsOpen=false, myId=null, roomId=null, role=null;
    let pc=null, localStream=null;
    let mute=false, camOn=true, fitMode='auto', currentFacing='user';
    let isQueuing=false, inCall=false, autoCycle=false, userHardStop=false;
    let layoutMode='split'; // 'split' | 'duo'

    const iceServers=[{urls:'stun:stun.l.google.com:19302'}];

    const TARGET={ width:1280, height:720, frameRate:30, aspectRatio:16/9 };

    async function ensureMedia(constraints){
      try{
        const base = constraints || {
          video:{ width:{ideal:TARGET.width}, height:{ideal:TARGET.height}, frameRate:{ideal:TARGET.frameRate}, aspectRatio:TARGET.aspectRatio, facingMode: currentFacing },
          audio:{ echoCancellation:true, noiseSuppression:true }
        };
        const stream = await navigator.mediaDevices.getUserMedia(base);

        const vTrack = stream.getVideoTracks()[0];
        if(vTrack?.applyConstraints){
          try{
            await vTrack.applyConstraints({
              width:{ideal:TARGET.width}, height:{ideal:TARGET.height},
              frameRate:{ideal:TARGET.frameRate}, aspectRatio:TARGET.aspectRatio,
              resizeMode:'none'
            });
          }catch(_){}
        }

        if(!localStream){
          localStream = stream;
        }else{
          const newV = stream.getVideoTracks()[0];
          const oldV = localStream.getVideoTracks()[0];
          if(oldV) oldV.stop();
          localStream.removeTrack(oldV);
          localStream.addTrack(newV);
          const sender = pc?.getSenders().find(s=>s.track && s.track.kind==='video');
          if(sender) await sender.replaceTrack(newV);
        }

        attachLocal(localStream);
        return localStream;
      }catch(e){
        alert("Permite cámara y micrófono para continuar.\n" + (e?.message||e));
        throw e;
      }
    }

    function attachLocal(stream){
      localVideo.srcObject = stream;
      pipVideo.srcObject   = stream;
      setSplitAspectFromTracks();
    }

    function makePC(){
      pc = new RTCPeerConnection({iceServers});
      pc.onicecandidate = (e)=>{ if(e.candidate) send({type:'ice', candidate:e.candidate}); };
      pc.ontrack = (e)=>{
        remoteVideo.srcObject = e.streams[0];
        // Ajustes visuales cuando llega el remoto
        setTimeout(()=>{
          setSplitAspectFromTracks();
          autoFitRemote(remoteVideo, remoteTile, (layoutMode==='duo')?'duo':'split');
        }, 50);
      };
      pc.onconnectionstatechange = ()=> {
        const st = pc.connectionState;
        if(st==='connected'){
          inCall = true;
          setStatus('Conectado'); overlay.classList.remove('show'); enableInCall(true);
        }
        if(st==='disconnected' || st==='failed'){ handleCallEnded('conn:'+st); }
        if(st==='closed'){ setStatus('Cerrado'); }
      };
      return pc;
    }

    function connectWS(){
      return new Promise((resolve,reject)=>{
        if(ws && wsOpen) return resolve();
        try{ ws = new WebSocket(window.WS_SIGNALLING_URL); }catch(e){ return reject(e); }
        ws.onopen  = ()=>{ wsOpen=true; resolve(); };
        ws.onerror = (e)=>{ console.error("WS error", e); reject(e); };
        ws.onclose = ()=>{ wsOpen=false; };
        ws.onmessage = async (msg)=>{
          const data = JSON.parse(msg.data);
          if(data.type==='welcome'){ myId=data.id; }
          if(data.type==='matched'){
            roomId=data.roomId; role=data.role;
            setStatus('Pareja encontrada · Conectando…');
            overlay.classList.add('show');
            if(data.peer && data.peer.name){ peerLabel.classList.remove('hidden'); peerLabel.textContent = 'Pareja: '+(data.peer.name||'—'); }
            try{ await startWebRTC(role); }catch(e){ setStatus('Error WebRTC: '+e.message); overlay.classList.remove('show'); }
          }
          if(data.type==='offer'){
            await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
            const answer = await pc.createAnswer(); await pc.setLocalDescription(answer);
            send({type:'answer', sdp:answer});
          }
          if(data.type==='answer'){ await pc.setRemoteDescription(new RTCSessionDescription(data.sdp)); }
          if(data.type==='ice'){ try{ await pc.addIceCandidate(data.candidate); }catch(e){} }
          if(data.type==='peer-left'){ handleCallEnded('peer-left'); }
        };
      });
    }

    function send(payload){
      if(wsOpen){ ws.send(JSON.stringify({ ...payload, roomId, from: myId })); }
    }

    async function startWebRTC(role){
      await ensureMedia();
      makePC();
      localStream.getTracks().forEach(t=>pc.addTrack(t, localStream));
      if(role==='offer'){
        const offer = await pc.createOffer(); await pc.setLocalDescription(offer);
        send({type:'offer', sdp:offer});
      }
    }

    // Limpieza
    function cleanupPeer({ keepLocal = true, closeWsToo = false } = {}){
      if(pc){ try{pc.close()}catch{}; pc=null; }
      if(!keepLocal && localStream){
        localStream.getTracks().forEach(t=>t.stop());
        localStream=null; localVideo.srcObject=null; pipVideo.srcObject=null;
      }
      remoteVideo.srcObject=null; roomId=null; role=null; inCall=false;
      if(closeWsToo && ws){ try{ ws.close(); }catch{} ws=null; wsOpen=false; }
      peerLabel.classList.add('hidden'); peerLabel.textContent='Pareja: —';
    }

    function enableInCall(connected){
      if(btnStart) btnStart.disabled = connected;
      if(btnNext)  btnNext.disabled  = !connected;
      if(btnStop)  btnStop.disabled  = !connected;

      if(mobileFab) mobileFab.textContent = connected ? 'Detener' : 'Iniciar videochat';
    }

    // Auto-cycle
    function handleCallEnded(reason){
      console.log('Call ended:', reason);
      cleanupPeer({ keepLocal:true, closeWsToo:false });
      if(autoCycle && !userHardStop){
        setStatus('Buscando siguiente…'); overlay.classList.add('show'); enableInCall(false);
        setTimeout(()=>{ findNext(); }, 400);
      }else{
        overlay.classList.remove('show'); enableInCall(false);
      }
    }

    async function joinQueue(){
      if(!currentUser){ alert('Inicia sesión con Google'); return; }
      if(isQueuing) return;
      isQueuing = true; autoCycle = true; userHardStop = false;
      enableInCall(false);
      overlay.classList.add('show');
      try{
        if(!chosenGender) chosenGender = localStorage.getItem('ttv_gender') || 'Hombre';
        const displayName = currentUser.displayName || '—';
        await connectWS();
        await ensureMedia();
        send({type:'find', gender: chosenGender, displayName});
        setStatus('En cola…');
      }catch(e){
        console.error(e); setStatus('Error de conexión WS'); overlay.classList.remove('show'); isQueuing=false; autoCycle=false;
      }
    }

    function findNext(){
      const displayName = currentUser?.displayName || '—';
      const gender = chosenGender || localStorage.getItem('ttv_gender') || 'Hombre';
      if(!wsOpen){ connectWS().then(()=>send({type:'find', gender, displayName})); }
      else { send({type:'find', gender, displayName}); }
    }

    async function nextMatch(){
      userHardStop = false; autoCycle = true;
      try{
        send({type:'leave'});
        cleanupPeer({ keepLocal:true, closeWsToo:false });
        setStatus('Buscando siguiente…'); overlay.classList.add('show'); enableInCall(false);
        await ensureMedia();
        findNext();
      }catch(e){ console.error(e); setStatus('Error WS (siguiente)'); }
    }

    function stopAll(){
      userHardStop = true; autoCycle = false; isQueuing = false;
      try{ send({type:'leave'}); }catch{}
      cleanupPeer({ keepLocal:true, closeWsToo:false });
      overlay.classList.remove('show');
      setStatus('Detenido'); enableInCall(false);
    }

    /* ===== Layout ===== */
    function setLayout(mode){
      layoutMode = mode;
      stage.classList.remove('layout-split','layout-duo');

      if(mode==='split'){
        stage.classList.add('layout-split');
        localTile.style.removeProperty('display');   // ambos mosaicos visibles
        pip.style.display = 'none';                  // PiP oculto en split
        setSplitAspectFromTracks();
      }else{
        stage.classList.add('layout-duo');
        localTile.style.display = 'none';            // NO duplicar local
        pip.style.display = 'block';                 // PiP visible
      }

      applyFitSmart();
      fitVH();
      setTimeout(()=>autoFitRemote(remoteVideo, remoteTile, (mode==='duo')?'duo':'split'),0);
    }

    function isMobile(){ return window.matchMedia('(max-width: 640px)').matches }

    function initLayoutForDevice(){
      if(isMobile()){
        setLayout('duo');               // móvil: siempre Duo
        if(btnLayout) btnLayout.style.display='none';
        if(btnDuo)    btnDuo.style.display='none';
        if(btnFit)    btnFit.style.display='none';
        if(btnExpand) btnExpand.style.display='none';
      }else{
        setLayout('split');             // PC por defecto 50/50
      }
      fitVH();
    }

    /* ===== Auto-Fit inteligente ===== */
    function autoFitRemote(remoteVideoEl, containerEl, prefer='duo') {
      const stream = remoteVideoEl.srcObject;
      const vt = stream?.getVideoTracks?.()[0];
      const s = vt?.getSettings?.();
      if (!s?.width || !s?.height) return;

      const videoAR = s.width / s.height;
      const rect = containerEl.getBoundingClientRect();
      const boxAR  = rect.width / rect.height;

      // 0 = idénticos; >0.1 ya se nota diferencia
      const diff = Math.abs(Math.log(videoAR/boxAR));
      const BIG_DIFF = 0.12;

      let fit;
      if (diff > BIG_DIFF) fit = 'contain';
      else fit = (prefer === 'duo') ? 'cover' : 'contain';

      remoteVideoEl.style.objectFit = fit;
      remoteVideoEl.style.background = (fit==='contain') ? '#000' : '#0b1324';
    }

    function applyFitSmart(){
      if(layoutMode === 'split'){
        // Ver más en 50/50
        [remoteVideo, localVideo].forEach(v=>{
          if(!v) return;
          v.style.objectFit = 'contain';
          v.style.background = '#000';
        });
      }else{
        // Duo estilo app de mensajería
        [remoteVideo, pipVideo].forEach(v=>{
          if(!v) return;
          v.style.objectFit = 'cover';
          v.style.background = '#0b1324';
        });
      }
    }

    /* ===== Ajuste dinámico del aspect-ratio en split ===== */
    function setSplitAspectFromTracks(){
      if(layoutMode !== 'split') return;

      const setRatio = (tileEl, track) => {
        try{
          const s = track?.getSettings?.();
          if(!s?.width || !s?.height) return;
          tileEl.style.aspectRatio = (s.width / s.height);
        }catch(e){}
      };

      const lv = localStream?.getVideoTracks?.()[0];
      if(lv) setRatio(localTile, lv);

      const rStream = remoteVideo?.srcObject;
      const rv = rStream?.getVideoTracks?.()[0];
      if(rv) setRatio(remoteTile, rv);
    }

    /* ===== Fullscreen y altura útil ===== */
    async function toggleFullscreen(){
      try{
        if(document.fullscreenElement){ await document.exitFullscreen(); }
        else{ await videoShell.requestFullscreen({ navigationUI:'hide' }); }
      }catch(e){}
    }

    function fitVH(){
      const rect = videoShell.getBoundingClientRect();
      const margen = 16;
      const h = Math.max(420, window.innerHeight - rect.top - margen);
      videoShell.style.setProperty('--vh', h + 'px');
    }
    window.addEventListener('load', fitVH);
    window.addEventListener('resize', fitVH);
    document.addEventListener('visibilitychange', fitVH);

    /* ===== PiP arrastrable + doble click para alternar layout ===== */
    (function makePipDraggable(){
      let dragging = false, startX=0, startY=0, origX=0, origY=0;

      const getBounds = ()=>{
        const shellRect = videoShell.getBoundingClientRect();
        const pipRect = pip.getBoundingClientRect();
        return {
          minX: 8,
          minY: 8,
          maxX: shellRect.width - pipRect.width - 8,
          maxY: shellRect.height - pipRect.height - 8
        };
      };

      const setPos = (x,y)=>{
        const b = getBounds();
        const nx = Math.max(b.minX, Math.min(x, b.maxX));
        const ny = Math.max(b.minY, Math.min(y, b.maxY));
        pip.style.transform = `translate(${nx}px, ${ny}px)`;
      };

      const onDown = (clientX, clientY)=>{
        dragging = true; pip.classList.add('dragging');
        const m = /translate\(([-\d.]+)px,\s*([-\d.]+)px\)/.exec(pip.style.transform||"");
        origX = m ? parseFloat(m[1]) : 0;
        origY = m ? parseFloat(m[2]) : 0;
        startX = clientX; startY = clientY;
      };

      const onMove = (clientX, clientY)=>{
        if(!dragging) return;
        const dx = clientX - startX;
        const dy = clientY - startY;
        setPos(origX + dx, origY + dy);
      };

      const onUp = ()=>{
        if(!dragging) return;
        dragging = false; pip.classList.remove('dragging');
      };

      pip.addEventListener('mousedown', e=>{ e.preventDefault(); onDown(e.clientX, e.clientY); });
      window.addEventListener('mousemove', e=> onMove(e.clientX, e.clientY));
      window.addEventListener('mouseup', onUp);

      pip.addEventListener('touchstart', e=>{
        const t = e.touches[0]; onDown(t.clientX, t.clientY);
      }, {passive:true});
      window.addEventListener('touchmove', e=>{
        const t = e.touches[0]; onMove(t.clientX, t.clientY);
      }, {passive:true});
      window.addEventListener('touchend', onUp);

      // posición inicial (esquina inferior derecha)
      setTimeout(()=>{
        const b = getBounds();
        setPos(b.maxX, b.maxY);
      }, 0);
    })();

    // Doble click / tap para alternar layout rápidamente
    let dblClkTimer=null;
    function quickToggleLayout(){
      setLayout(layoutMode==='duo' ? 'split' : 'duo');
    }
    remoteVideo.addEventListener('dblclick', quickToggleLayout);
    remoteVideo.addEventListener('touchend', (e)=>{
      if(dblClkTimer){ clearTimeout(dblClkTimer); dblClkTimer=null; quickToggleLayout(); }
      else dblClkTimer=setTimeout(()=>{ dblClkTimer=null; }, 220);
    }, {passive:true});

    /* ===== Botones (PC) ===== */
    btnLayout?.addEventListener('click', ()=> setLayout('split'));
    btnDuo   ?.addEventListener('click', ()=> setLayout('duo'));
    btnExpand?.addEventListener('click', toggleFullscreen);
    btnFit   ?.addEventListener('click', ()=>{
      fitMode = (fitMode==='auto') ? 'contain' : 'auto';
      btnFit.textContent = `Ajuste: ${fitMode}`;
      applyFitSmart();
      autoFitRemote(remoteVideo, remoteTile, (layoutMode==='duo')?'duo':'split');
    });

    // PC: sesión
    btnStart ?.addEventListener('click', joinQueue);
    btnNext  ?.addEventListener('click', nextMatch);
    btnStop  ?.addEventListener('click', stopAll);

    // MÓVIL: un solo botón
    mobileFab?.addEventListener('click', ()=>{
      if(inCall || isQueuing){ stopAll(); }
      else { joinQueue(); }
    });

    btnSalirChat?.addEventListener('click', ()=>{ stopAll(); auth.signOut(); });

    // Redimensionado contenedor: recalcular auto-fit
    const ro = new ResizeObserver(()=>{
      autoFitRemote(remoteVideo, remoteTile, (layoutMode==='duo')?'duo':'split');
    });
    ro.observe(remoteTile);

    // Salida limpia
    window.addEventListener('beforeunload', ()=>{ try{ send({type:'leave'}); }catch{} });

  </script>
</body>
</html>
