<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
  <title>TortillaTV — simple</title>
  <meta name="theme-color" content="#faf9f6" />

  <!-- Fuentes y Tailwind -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@800&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ["Inter","system-ui","Segoe UI","Roboto"], display: ["Caveat","ui-serif"] },
          colors: { paper: "#faf9f6", rule: "#93c5fd66", marginRed: "#ef4444aa" },
          keyframes: { pageFlipIn: { "0%": { transform:"rotateY(-90deg) translateX(-20px)", opacity:0 }, "100%": { transform:"rotateY(0) translateX(0)", opacity:1 } } },
          animation: { pageFlipIn: "pageFlipIn .6s ease both" },
          boxShadow: { card: "0 12px 30px rgba(0,0,0,.07)" }
        }
      }
    }
  </script>

  <!-- Firebase (compat) SOLO para login de Google -->
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>

  <style>
    :root{ --paper:#faf9f6; --rule:#93c5fd66; --margin:#ef4444aa; --hole:#e5e7eb; --ink:#111827; }
    html,body{ height:100% }
    body{ background:var(--paper); color:var(--ink); -webkit-font-smoothing:antialiased; }
    /* Papel rayado */
    .paper-bg{ position:relative; min-height:100vh; background-image:repeating-linear-gradient(0deg, transparent, transparent 32px, var(--rule) 33px, var(--rule) 34px); }
    .paper-bg::before{ content:""; position:absolute; inset:0; background:linear-gradient(90deg, transparent 56px, var(--margin) 59px, transparent 62px); pointer-events:none }
    .paper-holes{ position:absolute; left:18px; top:96px; display:flex; flex-direction:column; gap:96px; pointer-events:none }
    .paper-hole{ width:18px; height:18px; border-radius:999px; background:var(--hole); box-shadow:inset 0 2px 4px rgba(0,0,0,.2) }

    .book{ perspective:1200px }
    .page{ transform-origin:left center; backface-visibility:hidden; transform-style:preserve-3d; transition:opacity .4s ease; }
    .page.hidden{ opacity:0; pointer-events:none; transform:rotateY(-90deg) translateX(-20px) }
    .page.visible{ opacity:1; transform:rotateY(0); animation:pageFlipIn .6s ease both }

    .card{ background:rgba(255,255,255,.8); border:2px solid rgba(17,24,39,.1); border-radius:20px; padding:12px; box-shadow:0 12px 30px rgba(0,0,0,.07); backdrop-filter:blur(6px) }

    .hero{ position:relative; min-height:78vh; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center }
    .ttv{ position:relative; display:inline-block }
    .ttv .word{ display:inline-block; transform-origin:50% 70%; animation:ttv-wobble 2.4s ease-in-out infinite }
    .ttv .word:nth-child(2){ animation-delay:.15s }
    .ttv .word:nth-child(3){ animation-delay:.3s }
    .ttv .accent{ display:inline-block; padding-inline:.15em; transform:rotate(-2deg); text-shadow:0 2px 0 #ffe4e6 }
    @keyframes ttv-wobble{ 0%,100%{ transform:translateY(0) rotate(0) } 25%{ transform:translateY(-4px) rotate(-1.2deg) } 50%{ transform:translateY(2px) rotate(.8deg) } 75%{ transform:translateY(-2px) rotate(-.6deg) } }
    .spark{ position:absolute; width:14px; height:14px; border-radius:3px; transform:rotate(45deg); background:linear-gradient(135deg, rgba(244,63,94,.9), rgba(59,130,246,.9)); box-shadow:0 6px 16px rgba(0,0,0,.18); animation:spark-float 4.5s ease-in-out infinite }
    .spark.s1{ top:-18px; left:-38px; animation-delay:.2s }
    .spark.s2{ top:-24px; right:-28px; animation-delay:.6s }
    .spark.s3{ bottom:-22px; left:18px; animation-delay:1s }
    @keyframes spark-float{ 0%,100%{ transform:rotate(45deg) translateY(0) } 50%{ transform:rotate(45deg) translateY(-10px) } }

    .scribble{ width:min(920px,92vw); height:32px; margin-inline:auto }
    .scribble path{ stroke:rgba(239,68,68,.7); stroke-width:6; fill:none; stroke-linecap:round; stroke-dasharray:1400; animation:scribble 2s ease forwards }
    @keyframes scribble{ from{ stroke-dashoffset:1400 } to{ stroke-dashoffset:0 } }

    .corner{ position:absolute; right:min(2rem,5vw); top:clamp(10px,4vh,40px); display:flex; gap:.5rem; align-items:center; z-index:10 }
    .corner .note{ font-family:"Caveat", ui-serif; font-weight:800; font-size:clamp(18px,3.8vw,34px); background:#fff7cc; color:#0b1324; padding:.15em .45em; border-radius:.5rem; box-shadow:0 4px 0 rgba(0,0,0,.2); transform:rotate(-2.5deg) }
    .marquee{ position:relative; width:min(42ch,70vw); overflow:hidden; border-radius:.5rem; border:2px dashed rgba(17,24,39,.2); background:rgba(255,255,255,.75) }
    .marquee ul{ display:flex; gap:2.5rem; white-space:nowrap; padding:.35rem .75rem; animation:marquee-scroll 14s linear infinite }
    .marquee li{ list-style:none; font-family:"Caveat"; font-size:clamp(16px,3.2vw,30px); font-weight:800; color:#111827 }
    @keyframes marquee-scroll{ 0%{ transform:translateX(0) } 100%{ transform:translateX(-50%) } }

    .videos.split{ display:grid; grid-template-columns:1fr 1fr; gap:1rem }
    .fake-video{ background:linear-gradient(135deg, rgba(15,23,42,.06), rgba(100,116,139,.12)); border-radius:16px; min-height:260px }
    @media (max-width: 640px){ .hero{ min-height:72vh } .marquee{ width:min(34ch,88vw) } }
  </style>
</head>
<body class="font-sans">
  <div class="paper-bg">
    <div class="paper-holes"><div class="paper-hole"></div><div class="paper-hole"></div><div class="paper-hole"></div></div>

    <main class="book mx-auto max-w-5xl px-6 py-10">
      <!-- PÁGINA 1: LANDING (MISMO DISEÑO) -->
      <section id="page-landing" class="page visible">
        <div class="hero">
          <!-- Esquinita con frases -->
          <div class="corner">
            <span class="note">a mano</span>
            <div class="marquee">
              <ul id="cornerMessages">
                <li>Kristoff</li>
                <li>Astroboy</li>
                <li>A ochoa lo mataron a balazos</li>
                <li>Kristoff</li>
                <li>Astroboy</li>
                <li>A ochoa lo mataron a balazos</li>
              </ul>
            </div>
          </div>

          <!-- Título animado -->
          <h1 class="font-display font-extrabold select-none ttv" style="font-size:clamp(56px,10vw,140px); line-height:.9; text-shadow:0 1px 0 #fff, 0 10px 18px rgba(0,0,0,.15)">
            <span class="word">Tortilla</span><span class="accent text-rose-600">TV</span>
            <span class="spark s1"></span><span class="spark s2"></span><span class="spark s3"></span>
          </h1>

          <!-- Subtítulo -->
          <p class="mt-4 text-neutral-700 text-lg">Video chat aleatorio</p>

          <!-- Selección de género con iconos -->
          <div class="mt-6 grid grid-cols-3 gap-3 max-w-md">
            <button data-gen="Hombre" class="gen card py-4 flex flex-col items-center gap-2">
              <svg width="32" height="32" viewBox="0 0 24 24"><path d="M14 4h6v6h-2V7.41l-4.3 4.3a6 6 0 1 1-1.41-1.41L16.59 6H14V4Z"/></svg>
              <span class="font-semibold">Hombre</span>
            </button>
            <button data-gen="Mujer" class="gen card py-4 flex flex-col items-center gap-2">
              <svg width="32" height="32" viewBox="0 0 24 24"><path d="M12 2a6 6 0 0 0 0 12 6 6 0 0 0 0-12Zm1 13.9A8 8 0 1 1 10 2.1V6H8v2h2v2H8v2h2v2.1Z"/></svg>
              <span class="font-semibold">Mujer</span>
            </button>
            <button data-gen="Lada" class="gen card py-4 flex flex-col items-center gap-2">
              <svg width="32" height="32" viewBox="0 0 24 24"><path d="M3 13l1.5-4.5A3 3 0 0 1 7.4 6H16.6a3 3 0 0 1 2.9 2.5L21 13v5a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2H8a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-5Zm3 .5a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3Zm12 0a1.5 1.5 0 1 0-.001 3.001A1.5 1.5 0 0 0 18 13.5Z"/></svg>
              <span class="font-semibold">Lada</span>
            </button>
          </div>
          <p id="genElegido" class="mt-2 text-sm text-neutral-600"></p>

          <!-- Google login (igual estilo) -->
          <button id="btn-google" class="mt-6 rounded-xl border-2 border-neutral-900/40 bg-white/90 px-7 py-3.5 font-semibold shadow disabled:opacity-50" disabled>
            Iniciar con Google
          </button>

          <!-- Línea manuscrita roja -->
          <svg class="scribble mt-6" viewBox="0 0 1200 100" preserveAspectRatio="none" aria-hidden="true">
            <path d="M10,70 C200,20 400,120 600,60 C800,0 1000,120 1190,50"/>
          </svg>
        </div>
      </section>

      <!-- PÁGINA 2: SALA DE VIDEO -->
      <section id="page-chat" class="page hidden">
        <div class="card p-3 mb-4">
          <div class="flex flex-wrap items-center gap-2">
            <button id="btn-start" class="rounded-full border-2 border-neutral-900/30 bg-white/80 px-4 py-2 text-sm font-semibold shadow">Buscar</button>
            <button id="btn-next"  class="rounded-full border-2 border-neutral-900/30 bg-white/80 px-4 py-2 text-sm font-semibold shadow">Siguiente</button>
            <button id="btn-stop"  class="rounded-full border-2 border-neutral-900/30 bg-white/80 px-4 py-2 text-sm font-semibold shadow">Detener</button>
            <div class="ml-auto flex items-center gap-2 text-sm">
              <span id="status" class="text-neutral-700">Listo</span>
              <span id="you-badge" class="hidden text-xs px-2 py-1 rounded-full border border-black/20 bg-white/70">Tú: —</span>
            </div>
          </div>
        </div>

        <div class="videos split" id="videoArea">
          <div class="card">
            <div class="-mt-4 -ml-4 inline-block rotate-[-4deg] bg-yellow-200 px-2 py-1 text-[10px] font-bold text-neutral-800 shadow">Pareja</div>
            <video id="remoteVideo" autoplay playsinline class="fake-video h-[340px] w-full"></video>
          </div>
          <div class="card">
            <div class="-mt-4 -ml-4 inline-block rotate-[-4deg] bg-yellow-200 px-2 py-1 text-[10px] font-bold text-neutral-800 shadow">Tú</div>
            <video id="localVideo" autoplay playsinline muted class="fake-video h-[340px] w-full"></video>
            <div class="mt-3 flex items-center gap-2 text-xs">
              <button id="btn-mute" class="rounded-full border px-3 py-1">Mute</button>
              <button id="btn-cam"  class="rounded-full border px-3 py-1">Apagar cam</button>
            </div>
          </div>
        </div>

        <div class="mt-6 flex items-center justify-center">
          <button id="btn-salir-chat" class="rounded-full border-2 border-neutral-900/30 bg-white/80 px-5 py-2 text-sm font-semibold shadow">Salir</button>
        </div>
      </section>
    </main>
  </div>

  <!-- SCRIPTS -->
  <script>
    // ====== CONFIGURACIÓN ======
    const WS_SIGNALLING_URL = "ws://localhost:8080"; // Cambia a wss://tu-dominio en producción HTTPS
    const firebaseConfig = {
      apiKey: "AIzaSyBVuvV7NOaqkN6arT3xPTBdxMZg7TTPhlM",
      authDomain: "tortillatv-bf0c6.firebaseapp.com",
      projectId: "tortillatv-bf0c6",
      storageBucket: "tortillatv-bf0c6.firebasestorage.app",
      messagingSenderId: "193994912181",
      appId: "1:193994912181:web:03464c47f30fc5ac4d69fc"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    // ===========================

    // UI helpers
    const pages = { landing: qs('#page-landing'), chat: qs('#page-chat') };
    function qs(s,root=document){ return root.querySelector(s) }
    function show(k){ Object.values(pages).forEach(p=>{p.classList.add('hidden');p.classList.remove('visible')}); pages[k].classList.remove('hidden'); pages[k].classList.add('visible'); window.scrollTo({top:0,behavior:'smooth'}) }
    function setStatus(t){ const el=qs('#status'); if(el) el.textContent=t }

    // Mensajes de la esquina (doble para bucle)
    const MESSAGES=['Kristoff','Astroboy','A ochoa lo mataron a balazos'];
    (function marqueeDuplicate(){
      const ul = document.getElementById('cornerMessages');
      if(ul){ ul.innerHTML=''; const arr=[...MESSAGES,...MESSAGES]; for(const m of arr){ const li=document.createElement('li'); li.textContent=m; ul.appendChild(li); } }
    })();
    setInterval(()=>{
      const titleWords = document.querySelectorAll('.ttv .word, .ttv .accent');
      titleWords.forEach((el)=>{ el.style.animationDelay = (Math.random()*0.6).toFixed(2)+'s'; });
    }, 3000);

    // Estado básico
    let chosenGender=null;
    const genButtons=[...document.querySelectorAll('.gen')];
    const genElegido=qs('#genElegido');
    const btnGoogle=qs('#btn-google');

    genButtons.forEach(b=>{
      b.addEventListener('click', ()=>{
        genButtons.forEach(x=>x.classList.remove('ring','ring-rose-400'));
        b.classList.add('ring','ring-rose-400');
        chosenGender=b.getAttribute('data-gen');
        genElegido.textContent='Has elegido: '+chosenGender;
        btnGoogle.disabled=false;
      });
    });

    // Autenticación Google (opcional, solo para mostrar nombre)
    let currentUser=null;
    const youBadge=qs('#you-badge');
    auth.onAuthStateChanged((u)=>{
      currentUser=u||null;
      if(!u){ show('landing'); youBadge.classList.add('hidden'); return; }
      youBadge.classList.remove('hidden');
      youBadge.textContent=`Tú: ${u.displayName||'—'} · ${chosenGender||'—'}`;
      show('chat');
    });

    btnGoogle?.addEventListener('click', async ()=>{
      if(!chosenGender){ alert('Elige tu género primero'); return; }
      try{
        const provider=new firebase.auth.GoogleAuthProvider();
        await auth.signInWithPopup(provider);
        localStorage.setItem('ttv_gender', chosenGender);
      }catch(e){ alert('Error Google: '+e.message); }
    });

    // ====== Señalización + WebRTC (como instant, integrado a la sala) ======
    const btnStart=qs('#btn-start'), btnNext=qs('#btn-next'), btnStop=qs('#btn-stop'), btnSalirChat=qs('#btn-salir-chat');
    const localVideo=qs('#localVideo'), remoteVideo=qs('#remoteVideo');

    let ws=null, wsOpen=false, myId=null, roomId=null, role=null;
    let pc=null, localStream=null;
    let mute=false, camOn=true;

    const iceServers=[{urls:'stun:stun.l.google.com:19302'}];

    async function ensureMedia(){
      if(localStream) return localStream;
      try{
        localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
        localVideo.srcObject=localStream;
        return localStream;
      }catch(e){
        alert("Permite cámara y micrófono para continuar.");
        throw e;
      }
    }

    function makePC(){
      pc = new RTCPeerConnection({iceServers});
      pc.onicecandidate = (e)=>{ if(e.candidate) send({type:'ice', candidate:e.candidate}); };
      pc.ontrack = (e)=>{ remoteVideo.srcObject = e.streams[0]; };
      return pc;
    }

    function connectWS(){
      return new Promise((resolve,reject)=>{
        ws = new WebSocket(WS_SIGNALLING_URL);
        ws.onopen = ()=>{ wsOpen=true; resolve(); };
        ws.onerror = (e)=>reject(e);
        ws.onclose = ()=>{ wsOpen=false; };
        ws.onmessage = async (msg)=>{
          const data = JSON.parse(msg.data);
          if(data.type==='welcome'){ myId=data.id; }
          if(data.type==='matched'){
            roomId=data.roomId; role=data.role; setStatus('Pareja encontrada');
            await startWebRTC(role);
          }
          if(data.type==='offer'){
            await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
            const answer = await pc.createAnswer(); await pc.setLocalDescription(answer);
            send({type:'answer', sdp:answer});
          }
          if(data.type==='answer'){
            await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
          }
          if(data.type==='ice'){
            try{ await pc.addIceCandidate(data.candidate); }catch(e){}
          }
          if(data.type==='peer-left'){
            setStatus('La otra persona salió'); cleanupPeer(false);
          }
        };
      });
    }

    function send(payload){
      if(wsOpen){ ws.send(JSON.stringify({ ...payload, roomId, from: myId })); }
    }

    async function startWebRTC(role){
      await ensureMedia();
      makePC();
      localStream.getTracks().forEach(t=>pc.addTrack(t, localStream));
      if(role==='offer'){
        const offer = await pc.createOffer(); await pc.setLocalDescription(offer);
        send({type:'offer', sdp:offer});
      }
      setStatus('Conectando…');
    }

    function cleanupPeer(closeWsToo=true){
      if(pc){ pc.onicecandidate=null; pc.ontrack=null; try{pc.close()}catch{}; pc=null; }
      if(localStream){ localStream.getTracks().forEach(t=>t.stop()); localStream=null; localVideo.srcObject=null; }
      remoteVideo.srcObject=null; roomId=null; role=null;
      if(closeWsToo && ws){ try{ ws.close(); }catch{} ws=null; wsOpen=false; }
    }

    async function joinQueue(){
      if(!currentUser){ alert('Inicia sesión con Google'); return; }
      if(!chosenGender) chosenGender = localStorage.getItem('ttv_gender') || 'Hombre';
      if(!wsOpen) await connectWS();
      send({type:'find', gender: chosenGender, displayName: currentUser.displayName || '—'});
      setStatus('En cola…');
    }
    async function nextMatch(){
      send({type:'leave'}); cleanupPeer(false);
      send({type:'find', gender: chosenGender, displayName: currentUser.displayName || '—'});
      setStatus('Buscando siguiente…');
    }

    btnStart?.addEventListener('click', joinQueue);
    btnNext?.addEventListener('click', nextMatch);
    btnStop?.addEventListener('click', ()=>{ send({type:'leave'}); cleanupPeer(); setStatus('Detenido'); });
    btnSalirChat?.addEventListener('click', ()=>{ send({type:'leave'}); cleanupPeer(); auth.signOut(); });

    qs('#btn-mute')?.addEventListener('click', ()=>{
      if(!localStream) return;
      mute = !mute;
      localStream.getAudioTracks().forEach(t=>t.enabled = !mute);
    });
    qs('#btn-cam')?.addEventListener('click', ()=>{
      if(!localStream) return;
      camOn = !camOn;
      localStream.getVideoTracks().forEach(t=>t.enabled = camOn);
    });
  </script>
</body>
</html>
