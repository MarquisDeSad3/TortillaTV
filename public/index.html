<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TortillaTV</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <!-- Tailwind CDN (simple + r√°pido para estilos en una sola p√°gina) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --bg1:#0b1020;
      --bg2:#1a0b24;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.10);
      --stroke:rgba(255,255,255,.12);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.68);
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --brand:#a855f7;
    }

    html,body{ height:100%; }
    body{
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      color: var(--text);
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(168,85,247,.28), transparent 60%),
        radial-gradient(1000px 700px at 80% 20%, rgba(59,130,246,.22), transparent 62%),
        radial-gradient(900px 700px at 60% 90%, rgba(34,197,94,.14), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }

    .glass{
      background: var(--card);
      border:1px solid var(--stroke);
      box-shadow: 0 20px 50px rgba(0,0,0,.35);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:.5rem;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      padding:.75rem 1rem;
      border-radius: 14px;
      font-weight:600;
      transition: transform .15s ease, background .15s ease, border-color .15s ease, box-shadow .15s ease;
      user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,.10); transform: translateY(-1px); }
    .btn:active{ transform: translateY(0px) scale(.99); }
    .btn-primary{
      background: linear-gradient(90deg, rgba(168,85,247,.9), rgba(59,130,246,.85));
      border-color: rgba(255,255,255,.18);
      box-shadow: 0 18px 40px rgba(168,85,247,.18);
    }
    .btn-primary:hover{ background: linear-gradient(90deg, rgba(168,85,247,1), rgba(59,130,246,1)); }
    .btn-danger{ background: rgba(239,68,68,.14); border-color: rgba(239,68,68,.35); }
    .btn-danger:hover{ background: rgba(239,68,68,.22); }

    .chip{
      display:inline-flex; align-items:center; gap:.4rem;
      padding:.35rem .65rem;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      font-size:.85rem;
    }

    .page{
      display:none;
      animation: fadeIn .25s ease both;
    }
    .page.active{ display:block; }
    @keyframes fadeIn{
      from{ opacity:0; transform: translateY(6px); }
      to{ opacity:1; transform: translateY(0); }
    }

    .card{
      position:relative;
      overflow:hidden;
      border-radius: 18px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
      box-shadow: 0 18px 50px rgba(0,0,0,.25);
    }
    .card::before{
      content:"";
      position:absolute;
      inset:-2px;
      background: radial-gradient(600px 250px at 20% 0%, rgba(168,85,247,.30), transparent 60%),
                  radial-gradient(600px 250px at 80% 0%, rgba(59,130,246,.22), transparent 60%);
      opacity:.9;
      pointer-events:none;
    }
    .card > *{ position:relative; }
    .card:hover{
      transform: translateY(-3px);
      border-color: rgba(255,255,255,.22);
      box-shadow: 0 26px 70px rgba(0,0,0,.36);
    }
    .card:active{ transform: translateY(-1px); }

    .tile{
      position:relative;
      border-radius: 18px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.35);
      box-shadow: 0 18px 50px rgba(0,0,0,.35);
      min-height: 240px;
    }
    .tile video{
      width:100%;
      height:100%;
      object-fit:cover;
      background: #000;
    }

    .overlay{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 16px;
      background: radial-gradient(800px 400px at 20% 20%, rgba(168,85,247,.10), transparent 55%),
                  rgba(0,0,0,.55);
      color: rgba(255,255,255,.92);
      text-align:center;
      gap: 12px;
    }
    .overlay.hidden{ display:none; }

    .spinner{
      width: 18px; height: 18px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,.22);
      border-top-color: rgba(255,255,255,.90);
      animation: spin 1s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    .pip{
      position:absolute;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      width: 240px;
      aspect-ratio: 16/9;
      border-radius: 14px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 20px 60px rgba(0,0,0,.55);
      background: rgba(0,0,0,.5);
      display:none;
      z-index: 40;
    }
    .pip.show{ display:block; }
    .pip video{ width:100%; height:100%; object-fit:cover; }

    /* Mobile layout */
    .m-stage{
      position: relative;
      border-radius: 18px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.35);
      box-shadow: 0 18px 50px rgba(0,0,0,.35);
    }
    .m-top{ height: 52vh; }
    .m-bottom{ height: 36vh; border-top:1px solid rgba(255,255,255,.12); }
    .m-mini{
      position:absolute;
      right: 12px;
      bottom: 12px;
      width: 36%;
      max-width: 190px;
      aspect-ratio: 9/16;
      border-radius: 14px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 18px 40px rgba(0,0,0,.55);
      background:#000;
      display:none;
      z-index: 35;
    }
    .m-mini.show{ display:block; }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.7);
      border:1px solid rgba(255,255,255,.18);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 600;
      color: rgba(255,255,255,.92);
      display:none;
      z-index: 60;
    }
    .toast.show{ display:block; animation: toastIn .25s ease both; }
    @keyframes toastIn{
      from{ opacity:0; transform: translateX(-50%) translateY(10px); }
      to{ opacity:1; transform: translateX(-50%) translateY(0); }
    }
  </style>
</head>
<body>

  <div class="max-w-5xl mx-auto px-4 py-10">
    <header class="flex items-center justify-between gap-4 mb-8">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-2xl glass flex items-center justify-center">
          <span class="text-xl">ü•û</span>
        </div>
        <div>
          <div class="text-2xl sm:text-3xl font-extrabold tracking-tight">TortillaTV</div>
          <div class="text-sm text-white/60">Chat aleatorio por video ‚Äî Solo / Cupido</div>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <span id="chipUser" class="chip hidden"></span>
        <span id="chipAdmin" class="chip hidden">‚≠ê Admin</span>
      </div>
    </header>

    <!-- PAGE: LANDING -->
    <section id="pageLanding" class="page active">
      <div class="glass rounded-2xl p-6 sm:p-8">
        <div class="flex flex-col sm:flex-row gap-6 sm:gap-10">
          <div class="flex-1">
            <h2 class="text-2xl font-extrabold mb-2">Entra r√°pido</h2>
            <p class="text-white/70 mb-6">Elige tu g√©nero, tu nombre y edad. Luego puedes entrar con Google o como invitado.</p>

            <div class="mb-6">
              <div class="text-sm font-semibold text-white/80 mb-2">G√©nero</div>
              <div class="flex flex-wrap gap-2">
                <button id="btnGenderM" class="btn" type="button">üë® Hombre</button>
                <button id="btnGenderF" class="btn" type="button">üë© Mujer</button>
                <button id="btnGenderO" class="btn" type="button">üßë Otro</button>
              </div>
              <div id="genderHint" class="text-xs text-white/55 mt-2">Selecciona una opci√≥n.</div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-6">
              <div>
                <label class="text-sm font-semibold text-white/80">Nombre</label>
                <input id="inpName" class="mt-1 w-full rounded-xl bg-white/5 border border-white/10 px-4 py-3 outline-none focus:border-white/25" placeholder="Tu nombre..." maxlength="24" />
              </div>
              <div>
                <label class="text-sm font-semibold text-white/80">Edad</label>
                <input id="inpAge" type="number" inputmode="numeric" min="13" max="99" class="mt-1 w-full rounded-xl bg-white/5 border border-white/10 px-4 py-3 outline-none focus:border-white/25" placeholder="18" />
              </div>
            </div>

            <div class="flex flex-col sm:flex-row gap-3">
              <button id="btnGoogle" class="btn btn-primary" type="button">üîê Entrar con Google</button>
              <button id="btnGuest" class="btn" type="button">üö™ Entrar como invitado</button>
            </div>

            <p class="text-xs text-white/55 mt-4">
              Nota: te pedir√° c√°mara y micr√≥fono al iniciar un modo de chat.
            </p>
          </div>

          <div class="flex-1">
            <div class="card p-6">
              <div class="text-sm font-semibold text-white/70">¬øC√≥mo funciona?</div>
              <ul class="mt-3 space-y-2 text-white/75">
                <li>‚úÖ <b>Modo Solo</b>: 1 vs 1 aleatorio.</li>
                <li>üíò <b>Modo Cupido</b>: Kristoff (admin) arma una llamada de <b>3</b>.</li>
                <li>‚≠ê <b>Admin</b>: puede hostear Cupido y usar herramientas (ej: fake skip en Solo).</li>
              </ul>
              <div class="mt-6 p-4 rounded-xl bg-white/5 border border-white/10">
                <div class="text-sm font-semibold">Tip</div>
                <div class="text-sm text-white/70 mt-1">Si est√°s en Cupido y se va alguien, se reemplaza por otra persona si hay en cola.</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE: MODE SELECT -->
    <section id="pageMode" class="page">
      <div class="glass rounded-2xl p-6 sm:p-8">
        <div class="flex items-start justify-between gap-4 mb-6">
          <div>
            <h2 class="text-2xl font-extrabold">Elige un modo</h2>
            <p id="modeSubtitle" class="text-white/70 mt-1">Puedes cambiar de modo cuando quieras.</p>
          </div>
          <div class="flex gap-2">
            <button id="btnLogout" class="btn hidden" type="button">Cerrar sesi√≥n</button>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <button id="cardSolo" class="card text-left p-6" type="button">
            <div class="text-2xl">üé≤</div>
            <div class="mt-3 text-xl font-extrabold">Modo Solo</div>
            <div class="mt-1 text-sm text-white/70">Llamada 1 vs 1 aleatoria. No repite si hay m√°s gente.</div>
            <div class="mt-4 inline-flex items-center gap-2 text-sm font-semibold text-white/80">
              <span>Entrar</span> <span>‚Üí</span>
            </div>
          </button>

          <button id="cardCupid" class="card text-left p-6" type="button">
            <div class="text-2xl">üíò</div>
            <div class="mt-3 text-xl font-extrabold">Modo Cupido</div>
            <div id="cupidDesc" class="mt-1 text-sm text-white/70">Te unes a la cola y Kristoff arma una llamada de 3 (t√∫ + √©l + otra persona).</div>
            <div class="mt-4 inline-flex items-center gap-2 text-sm font-semibold text-white/80">
              <span id="cupidEnterLabel">Entrar</span> <span>‚Üí</span>
            </div>
          </button>

          <button id="cardKristoff" class="card text-left p-6" type="button">
            <div class="text-2xl">‚≠ê</div>
            <div class="mt-3 text-xl font-extrabold">Soy Kristoff</div>
            <div id="kristoffDesc" class="mt-1 text-sm text-white/70">Login admin (email + contrase√±a). Si ya est√°s logueado como admin, aqu√≠ lo ver√°s.</div>
            <div class="mt-4 inline-flex items-center gap-2 text-sm font-semibold text-white/80">
              <span id="kristoffEnterLabel">Abrir login</span> <span>‚Üí</span>
            </div>
          </button>
        </div>

        <div class="mt-6 flex flex-wrap items-center justify-between gap-3">
          <div class="text-sm text-white/60">
            <span class="font-semibold text-white/75">Atajo admin:</span> en Modo Solo, presiona <span class="chip">Enter</span> para fake skip.
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE: CHAT -->
    <section id="pageChat" class="page">
      <div class="glass rounded-2xl p-4 sm:p-6">
        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3 mb-4">
          <div>
            <div class="flex items-center gap-2">
              <span id="modePill" class="chip">Modo: ‚Äî</span>
              <span id="statusPill" class="chip">Estado: ‚Äî</span>
            </div>
            <div id="statusText" class="text-white/80 mt-2 text-sm">Preparando‚Ä¶</div>
          </div>

          <div class="flex flex-wrap gap-2 justify-start sm:justify-end">
            <button id="btnNext" class="btn" type="button">Siguiente</button>
            <button id="btnStop" class="btn btn-danger" type="button">Detener</button>
            <button id="btnMic" class="btn" type="button">üéôÔ∏è Mic</button>
            <button id="btnCam" class="btn" type="button">üé• Cam</button>
            <button id="btnBackModes" class="btn" type="button">‚Ü©Ô∏é Modos</button>
          </div>
        </div>

        <!-- Desktop stage -->
        <div class="relative hidden sm:block">
          <div id="pip" class="pip">
            <video id="pipVideo" autoplay playsinline muted></video>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <!-- Remote 0 (siempre visible) -->
            <div class="tile">
              <video id="remoteVideo0" autoplay playsinline></video>
              <div id="ovRemote0" class="overlay">
                <div class="spinner"></div>
                <div>
                  <div class="font-extrabold text-lg">Buscando‚Ä¶</div>
                  <div id="ovRemote0Sub" class="text-sm text-white/70 mt-1">Conectando</div>
                </div>
              </div>
            </div>

            <!-- Remote 1 (solo Cupido) -->
            <div id="tileRemote1" class="tile hidden">
              <video id="remoteVideo1" autoplay playsinline></video>
              <div id="ovRemote1" class="overlay">
                <div class="spinner"></div>
                <div>
                  <div class="font-extrabold text-lg">Buscando‚Ä¶</div>
                  <div id="ovRemote1Sub" class="text-sm text-white/70 mt-1">Esperando segunda persona</div>
                </div>
              </div>
            </div>

            <!-- Local (solo Solo) -->
            <div id="tileLocal" class="tile">
              <video id="localVideo" autoplay playsinline muted></video>
              <div id="ovLocal" class="overlay hidden">
                <div class="spinner"></div>
                <div>
                  <div class="font-extrabold text-lg">C√°mara apagada</div>
                  <div class="text-sm text-white/70 mt-1">Activa la c√°mara para verte.</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Mobile stage -->
        <div class="sm:hidden">
          <div class="m-stage">
            <div class="m-top">
              <video id="remoteVideoM" autoplay playsinline></video>
              <div id="ovRemoteM" class="overlay">
                <div class="spinner"></div>
                <div>
                  <div class="font-extrabold text-lg">Buscando‚Ä¶</div>
                  <div id="ovRemoteMSub" class="text-sm text-white/70 mt-1">Conectando</div>
                </div>
              </div>
            </div>

            <div class="m-bottom">
              <video id="localVideoM" autoplay playsinline muted></video>
            </div>

            <div id="mobileMini" class="m-mini">
              <video id="remoteVideoMini" autoplay playsinline></video>
            </div>
          </div>
        </div>

        <div class="mt-4 text-xs text-white/55">
          * Cupido = llamada de 3 (Kristoff + t√∫ + otra persona). Si no hay gente suficiente, puede tardar o completar asientos cuando entren.
        </div>
      </div>
    </section>

    <!-- Admin login modal -->
    <div id="modalKristoff" class="fixed inset-0 hidden items-center justify-center z-50">
      <div class="absolute inset-0 bg-black/60"></div>
      <div class="relative w-[92%] max-w-md glass rounded-2xl p-6">
        <div class="flex items-start justify-between gap-4">
          <div>
            <div class="text-xl font-extrabold">Login Kristoff (Admin)</div>
            <div class="text-sm text-white/70 mt-1">Email permitido + contrase√±a.</div>
          </div>
          <button id="btnCloseModal" class="btn" type="button">‚úï</button>
        </div>

        <div class="mt-4 space-y-3">
          <div>
            <label class="text-sm font-semibold text-white/80">Email</label>
            <input id="inpAdminEmail" class="mt-1 w-full rounded-xl bg-white/5 border border-white/10 px-4 py-3 outline-none focus:border-white/25" placeholder="christophergomez6903@gmail.com" />
          </div>
          <div>
            <label class="text-sm font-semibold text-white/80">Contrase√±a</label>
            <input id="inpAdminPass" type="password" class="mt-1 w-full rounded-xl bg-white/5 border border-white/10 px-4 py-3 outline-none focus:border-white/25" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
          </div>
        </div>

        <div class="mt-5 flex gap-2">
          <button id="btnKristoffLogin" class="btn btn-primary flex-1" type="button">Entrar</button>
          <button id="btnKristoffCancel" class="btn flex-1" type="button">Cancelar</button>
        </div>

        <div id="adminLoginHint" class="text-xs text-white/60 mt-3"></div>
      </div>
    </div>

    <div id="toast" class="toast"></div>
  </div>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <script>
    /*****************
     * Config
     *****************/
    const firebaseConfig = {
      apiKey: "AIzaSyC8Xyx4FYuDxPQJwh1y5mioKWm2asZNylU",
      authDomain: "tortillatv1.firebaseapp.com",
      projectId: "tortillatv1",
      storageBucket: "tortillatv1.appspot.com",
      messagingSenderId: "925489874907",
      appId: "1:925489874907:web:525fe80196db0198423504",
      measurementId: "G-ZL16XR8S01"
    };

    // ICE servers (STUN + TURN). Si no tienes TURN, puedes borrar el bloque TURN.
    const ICE_SERVERS = [
      { urls: "stun:stun.l.google.com:19302" },
      { urls: "stun:stun1.l.google.com:19302" },
      // TURN (opcional) - mantenlo si ya es tuyo y funciona.
      { urls: "turn:35.222.84.159:3478", username: "MiEspuma", credential: "Cl4uD1@2025" }
    ];

    /*****************
     * DOM helpers
     *****************/
    const $ = (id) => document.getElementById(id);

    const pageLanding = $("pageLanding");
    const pageMode = $("pageMode");
    const pageChat = $("pageChat");

    const chipUser = $("chipUser");
    const chipAdmin = $("chipAdmin");

    const btnGenderM = $("btnGenderM");
    const btnGenderF = $("btnGenderF");
    const btnGenderO = $("btnGenderO");
    const genderHint = $("genderHint");
    const inpName = $("inpName");
    const inpAge = $("inpAge");

    const btnGoogle = $("btnGoogle");
    const btnGuest = $("btnGuest");

    const btnLogout = $("btnLogout");

    const cardSolo = $("cardSolo");
    const cardCupid = $("cardCupid");
    const cardKristoff = $("cardKristoff");
    const cupidDesc = $("cupidDesc");
    const cupidEnterLabel = $("cupidEnterLabel");
    const kristoffDesc = $("kristoffDesc");
    const kristoffEnterLabel = $("kristoffEnterLabel");

    const modePill = $("modePill");
    const statusPill = $("statusPill");
    const statusText = $("statusText");

    const btnNext = $("btnNext");
    const btnStop = $("btnStop");
    const btnMic = $("btnMic");
    const btnCam = $("btnCam");
    const btnBackModes = $("btnBackModes");

    // Desktop videos
    const remoteVideo0 = $("remoteVideo0");
    const remoteVideo1 = $("remoteVideo1");
    const localVideo = $("localVideo");
    const tileRemote1 = $("tileRemote1");
    const tileLocal = $("tileLocal");
    const ovRemote0 = $("ovRemote0");
    const ovRemote1 = $("ovRemote1");
    const ovRemote0Sub = $("ovRemote0Sub");
    const ovRemote1Sub = $("ovRemote1Sub");

    const pip = $("pip");
    const pipVideo = $("pipVideo");

    // Mobile videos
    const remoteVideoM = $("remoteVideoM");
    const localVideoM = $("localVideoM");
    const mobileMini = $("mobileMini");
    const remoteVideoMini = $("remoteVideoMini");
    const ovRemoteM = $("ovRemoteM");
    const ovRemoteMSub = $("ovRemoteMSub");

    // Modal
    const modalKristoff = $("modalKristoff");
    const btnCloseModal = $("btnCloseModal");
    const btnKristoffCancel = $("btnKristoffCancel");
    const btnKristoffLogin = $("btnKristoffLogin");
    const inpAdminEmail = $("inpAdminEmail");
    const inpAdminPass = $("inpAdminPass");
    const adminLoginHint = $("adminLoginHint");

    // Toast
    const toast = $("toast");

    function showToast(msg, ms = 2200){
      toast.textContent = msg;
      toast.classList.add("show");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=>toast.classList.remove("show"), ms);
    }

    function showPage(page){
      [pageLanding, pageMode, pageChat].forEach(p=>p.classList.remove("active"));
      page.classList.add("active");
      window.scrollTo({top:0, behavior:"smooth"});
    }

    function isMobile(){
      return window.matchMedia("(max-width: 640px)").matches;
    }

    function setActiveGender(g){
      window._gender = g;
      [btnGenderM, btnGenderF, btnGenderO].forEach(b=>b.classList.remove("btn-primary"));
      if(g==="m") btnGenderM.classList.add("btn-primary");
      if(g==="f") btnGenderF.classList.add("btn-primary");
      if(g==="o") btnGenderO.classList.add("btn-primary");
      genderHint.textContent = g ? "Listo ‚úÖ" : "Selecciona una opci√≥n.";
    }

    btnGenderM.onclick = ()=>setActiveGender("m");
    btnGenderF.onclick = ()=>setActiveGender("f");
    btnGenderO.onclick = ()=>setActiveGender("o");

    /*****************
     * State
     *****************/
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    let currentUser = null; // firebase user OR guest object
    let isGuest = false;

    // Perfil local (lo manda al server para mostrar nombres, etc.)
    const profile = {
      gender: null,
      name: "",
      age: ""
    };

    // WebSocket
    let ws = null;
    let wsOpen = false;
    let myId = null;

    // Roles
    let IS_ADMIN = false;
    let IS_PRO = false;

    // Mode
    let mode = null; // "solo" | "cupid" | null
    let cupidRole = null; // "host" | "guest" | null

    // Media
    let localStream = null;
    let micOn = true;
    let camOn = true;

    // SOLO WebRTC
    let soloPC = null;
    let soloRoomId = null;
    let soloRole = null;
    let soloPeer = null;

    // GROUP (CUPID) WebRTC
    let groupActive = false;
    let groupSessionId = null;
    const groupPCs = new Map();      // peerId -> RTCPeerConnection
    const groupStreams = new Map();  // peerId -> MediaStream
    const groupSlotByPeer = new Map(); // peerId -> 0|1

    /*****************
     * UI helpers
     *****************/
    function setChipUser(text){
      if(!text){
        chipUser.classList.add("hidden");
        chipUser.textContent = "";
        return;
      }
      chipUser.textContent = text;
      chipUser.classList.remove("hidden");
    }

    function setAdminChip(on){
      if(on) chipAdmin.classList.remove("hidden");
      else chipAdmin.classList.add("hidden");

      // Actualiza textos del modo
      if(on){
        kristoffDesc.textContent = "Admin activo ‚úÖ (puedes hostear Cupido y usar herramientas).";
        kristoffEnterLabel.textContent = "Admin activo";
        cupidDesc.textContent = "Como admin, este bot√≥n inicia Cupido (HOST). Se unen 2 personas contigo (llamada de 3).";
        cupidEnterLabel.textContent = "Iniciar (Host)";
      }else{
        kristoffDesc.textContent = "Login admin (email + contrase√±a). Si ya est√°s logueado como admin, aqu√≠ lo ver√°s.";
        kristoffEnterLabel.textContent = "Abrir login";
        cupidDesc.textContent = "Te unes a la cola y Kristoff arma una llamada de 3 (t√∫ + √©l + otra persona).";
        cupidEnterLabel.textContent = "Entrar";
      }
    }

    function setStatus(modeLabel, statusLabel, text){
      modePill.textContent = "Modo: " + (modeLabel || "‚Äî");
      statusPill.textContent = "Estado: " + (statusLabel || "‚Äî");
      statusText.textContent = text || "";
    }

    function showSearchingOverlay(slot, show, subtitle){
      if(isMobile()){
        if(slot===0){
          if(subtitle) ovRemoteMSub.textContent = subtitle;
          ovRemoteM.classList.toggle("hidden", !show);
        }else{
          // slot1 on mobile is mini; we don't have overlay inside mini; we'll just show/hide mini video
          // show==true means keep mini visible but may be blank; we keep it visible only when in cupid mode.
        }
        return;
      }
      if(slot===0){
        if(subtitle) ovRemote0Sub.textContent = subtitle;
        ovRemote0.classList.toggle("hidden", !show);
      }else if(slot===1){
        if(subtitle) ovRemote1Sub.textContent = subtitle;
        ovRemote1.classList.toggle("hidden", !show);
      }
    }

    function attachLocalStream(){
      if(!localStream) return;
      localVideo.srcObject = localStream;
      localVideoM.srcObject = localStream;
      pipVideo.srcObject = localStream;
    }

    function attachRemoteToSlot(slot, stream){
      if(isMobile()){
        if(slot===0) remoteVideoM.srcObject = stream;
        else if(slot===1) remoteVideoMini.srcObject = stream;
        return;
      }
      if(slot===0) remoteVideo0.srcObject = stream;
      else if(slot===1) remoteVideo1.srcObject = stream;
    }

    function clearRemoteSlot(slot){
      if(isMobile()){
        if(slot===0) remoteVideoM.srcObject = null;
        else if(slot===1) remoteVideoMini.srcObject = null;
        return;
      }
      if(slot===0) remoteVideo0.srcObject = null;
      else if(slot===1) remoteVideo1.srcObject = null;
    }

    function updateLayoutForMode(){
      const mobile = isMobile();

      // Desktop-only toggles
      if(!mobile){
        // Solo -> local tile visible, remote1 hidden, pip hidden
        if(mode === "solo"){
          tileRemote1.classList.add("hidden");
          tileLocal.classList.remove("hidden");
          pip.classList.remove("show");
        }
        // Cupid -> remote1 visible, local tile hidden, pip shown
        if(mode === "cupid"){
          tileRemote1.classList.remove("hidden");
          tileLocal.classList.add("hidden");
          pip.classList.add("show");
        }
      }else{
        // Mobile: local bottom always visible
        pip.classList.remove("show");
        // Mini visible only in cupid mode
        if(mode === "cupid") mobileMini.classList.add("show");
        else mobileMini.classList.remove("show");
      }
    }

    window.addEventListener("resize", ()=>{
      updateLayoutForMode();
    });

    /*****************
     * Validation
     *****************/
    function grabProfileFromInputs(){
      profile.gender = window._gender || null;
      profile.name = (inpName.value || "").trim();
      profile.age = (inpAge.value || "").trim();
    }

    function validateProfile(){
      grabProfileFromInputs();
      if(!profile.gender){
        showToast("Selecciona tu g√©nero primero.");
        return false;
      }
      if(!profile.name){
        showToast("Escribe tu nombre.");
        return false;
      }
      const ageNum = Number(profile.age || 0);
      if(!Number.isFinite(ageNum) || ageNum < 13 || ageNum > 99){
        showToast("Pon una edad v√°lida (13-99).");
        return false;
      }
      // persist
      localStorage.setItem("ttv_profile", JSON.stringify(profile));
      return true;
    }

    function loadProfile(){
      try{
        const raw = localStorage.getItem("ttv_profile");
        if(!raw) return;
        const p = JSON.parse(raw);
        if(p.gender) setActiveGender(p.gender);
        if(p.name) inpName.value = p.name;
        if(p.age) inpAge.value = p.age;
      }catch{}
    }
    loadProfile();

    /*****************
     * Auth
     *****************/
    auth.onAuthStateChanged((user)=>{
      if(user){
        currentUser = user;
        isGuest = false;
        setChipUser(user.displayName || user.email || "Usuario");
        btnLogout.classList.remove("hidden");
        showPage(pageMode);
        ensureWS().then(()=>identifyIfPossible()).catch(()=>{});
      }else{
        currentUser = null;
        IS_ADMIN = false;
        IS_PRO = false;
        setAdminChip(false);
        setChipUser(null);
        btnLogout.classList.add("hidden");
        showPage(pageLanding);
      }
    });

    btnLogout.onclick = async ()=>{
      try{ await auth.signOut(); }catch(e){}
      // also cleanup everything
      await stopAll("logout");
    };

    btnGoogle.onclick = async ()=>{
      if(!validateProfile()) return;
      const provider = new firebase.auth.GoogleAuthProvider();
      try{
        await auth.signInWithPopup(provider);
      }catch(err){
        console.error(err);
        showToast("No se pudo iniciar con Google.");
      }
    };

    btnGuest.onclick = async ()=>{
      if(!validateProfile()) return;
      // guest session (no firebase)
      isGuest = true;
      currentUser = { displayName: profile.name, email: null, guest: true };
      setChipUser(profile.name + " (Invitado)");
      btnLogout.classList.add("hidden");
      showPage(pageMode);
      // connect ws (as guest). We'll identify only with profile via mode messages.
      await ensureWS().catch(()=>{});
    };

    /*****************
     * Kristoff modal (admin login)
     *****************/
    function openKristoffModal(){
      inpAdminEmail.value = (inpAdminEmail.value || localStorage.getItem("ttv_admin_email") || "christophergomez6903@gmail.com").trim();
      inpAdminPass.value = "";
      adminLoginHint.textContent = "";
      modalKristoff.classList.remove("hidden");
      modalKristoff.classList.add("flex");
      setTimeout(()=>inpAdminPass.focus(), 50);
    }
    function closeKristoffModal(){
      modalKristoff.classList.add("hidden");
      modalKristoff.classList.remove("flex");
    }

    btnCloseModal.onclick = closeKristoffModal;
    btnKristoffCancel.onclick = closeKristoffModal;

    btnKristoffLogin.onclick = async ()=>{
      const email = (inpAdminEmail.value || "").trim().toLowerCase();
      const pass = (inpAdminPass.value || "");
      if(!email || !pass){
        adminLoginHint.textContent = "Completa email y contrase√±a.";
        return;
      }
      localStorage.setItem("ttv_admin_email", email);
      adminLoginHint.textContent = "Verificando‚Ä¶";
      try{
        await ensureWS();
        wsSend({
          type: "kristoff-login",
          email,
          password: pass,
          displayName: profile.name || currentUser?.displayName || "Kristoff"
        });
      }catch(err){
        console.error(err);
        adminLoginHint.textContent = "No se pudo conectar al servidor.";
      }
    };

    cardKristoff.onclick = ()=>{
      if(IS_ADMIN){
        showToast("Admin ya est√° activo ‚úÖ");
        return;
      }
      openKristoffModal();
    };

    // close modal on background click
    modalKristoff.addEventListener("click", (e)=>{
      if(e.target === modalKristoff) closeKristoffModal();
    });

    /*****************
     * WebSocket
     *****************/
    function wsUrl(){
      const proto = (location.protocol === "https:") ? "wss" : "ws";
      return `${proto}://${location.host}`;
    }

    function ensureWS(){
      if(wsOpen && ws) return Promise.resolve();
      return new Promise((resolve, reject)=>{
        ws = new WebSocket(wsUrl());
        wsOpen = false;

        ws.onopen = ()=>{
          wsOpen = true;
          resolve();
          identifyIfPossible();
        };

        ws.onmessage = (ev)=>{
          let msg = null;
          try{ msg = JSON.parse(ev.data); }catch{ return; }
          handleWS(msg);
        };

        ws.onclose = ()=>{
          wsOpen = false;
          myId = null;
          // If we're in a mode, show a message
          if(mode){
            setStatus(mode === "solo" ? "Solo" : "Cupido", "Offline", "Conexi√≥n al servidor cerrada. Recarga la p√°gina.");
          }
        };

        ws.onerror = (err)=>{
          console.error("WS error", err);
        };
      });
    }

    function wsSend(obj){
      if(!wsOpen || !ws) return;
      ws.send(JSON.stringify(obj));
    }

    function identifyIfPossible(){
      if(!wsOpen || !ws) return;
      const email = currentUser?.email || null;
      const displayName = currentUser?.displayName || profile.name || null;
      if(email){
        wsSend({ type:"identify", email, displayName });
      }
    }

    /*****************
     * Media
     *****************/
    async function ensureMedia(){
      if(localStream) return localStream;
      try{
        localStream = await navigator.mediaDevices.getUserMedia({
          video: { width: { ideal: 1280 }, height: { ideal: 720 }, facingMode: "user" },
          audio: true
        });
        micOn = true;
        camOn = true;
        attachLocalStream();
        updateMicCamButtons();
        return localStream;
      }catch(err){
        console.error(err);
        showToast("No se pudo acceder a c√°mara/mic.");
        throw err;
      }
    }

    function updateMicCamButtons(){
      btnMic.textContent = micOn ? "üéôÔ∏è Mic" : "üîá Mic";
      btnCam.textContent = camOn ? "üé• Cam" : "üö´ Cam";
    }

    btnMic.onclick = ()=>{
      if(!localStream) return;
      micOn = !micOn;
      localStream.getAudioTracks().forEach(t=>t.enabled = micOn);
      updateMicCamButtons();
    };

    btnCam.onclick = ()=>{
      if(!localStream) return;
      camOn = !camOn;
      localStream.getVideoTracks().forEach(t=>t.enabled = camOn);
      // show overlay if cam off in Solo local tile
      if(!camOn){
        $("ovLocal").classList.remove("hidden");
      }else{
        $("ovLocal").classList.add("hidden");
      }
      updateMicCamButtons();
    };

    /*****************
     * SOLO WebRTC
     *****************/
    function cleanupSolo(){
      if(soloPC){
        try{ soloPC.ontrack = null; soloPC.onicecandidate = null; soloPC.close(); }catch{}
      }
      soloPC = null;
      soloRoomId = null;
      soloRole = null;
      soloPeer = null;
      clearRemoteSlot(0);
      showSearchingOverlay(0, true, "Buscando en modo Solo‚Ä¶");
    }

    async function startSolo(){
      mode = "solo";
      cupidRole = null;
      updateLayoutForMode();
      setStatus("Solo", "Conectando", "Preparando c√°mara‚Ä¶");
      cleanupGroup(true);
      cleanupSolo();

      await ensureWS();
      await ensureMedia();
      attachLocalStream();

      // queue
      setStatus("Solo", "Buscando", "Buscando alguien‚Ä¶");
      showSearchingOverlay(0, true, "Buscando alguien‚Ä¶");
      wsSend({
        type:"find",
        displayName: profile.name || currentUser?.displayName || "Usuario",
        gender: profile.gender || null,
        age: profile.age || null
      });
    }

    async function initSoloPC(){
      if(!localStream) await ensureMedia();
      soloPC = new RTCPeerConnection({ iceServers: ICE_SERVERS });
      localStream.getTracks().forEach(track => soloPC.addTrack(track, localStream));
      soloPC.ontrack = (ev)=>{
        const [stream] = ev.streams;
        attachRemoteToSlot(0, stream);
        showSearchingOverlay(0, false);
        setStatus("Solo", "Conectado", "Conectado ‚úÖ");
      };
      soloPC.onicecandidate = (ev)=>{
        if(ev.candidate){
          wsSend({ type:"ice", candidate: ev.candidate });
        }
      };
    }

    async function handleSoloMatched(data){
      soloRoomId = data.roomId;
      soloRole = data.role;
      soloPeer = data.peer;
      await initSoloPC();

      if(soloRole === "offer"){
        const offer = await soloPC.createOffer();
        await soloPC.setLocalDescription(offer);
        wsSend({ type:"offer", sdp: offer.sdp });
      }
    }

    async function handleSoloOffer(sdp){
      if(!soloPC) await initSoloPC();
      await soloPC.setRemoteDescription({ type:"offer", sdp });
      const ans = await soloPC.createAnswer();
      await soloPC.setLocalDescription(ans);
      wsSend({ type:"answer", sdp: ans.sdp });
    }

    async function handleSoloAnswer(sdp){
      if(!soloPC) return;
      await soloPC.setRemoteDescription({ type:"answer", sdp });
    }

    async function handleSoloIce(candidate){
      if(!soloPC) return;
      try{ await soloPC.addIceCandidate(candidate); }catch{}
    }

    /*****************
     * GROUP WebRTC (Cupido)
     *****************/
    function cleanupGroup(silent=false){
      groupActive = false;
      groupSessionId = null;
      groupSlotByPeer.clear();
      groupStreams.clear();
      for(const [pid, pc] of groupPCs.entries()){
        try{ pc.ontrack = null; pc.onicecandidate = null; pc.close(); }catch{}
      }
      groupPCs.clear();
      clearRemoteSlot(0);
      clearRemoteSlot(1);

      if(!silent){
        showSearchingOverlay(0, true, "Esperando Cupido‚Ä¶");
        showSearchingOverlay(1, true, "Esperando Cupido‚Ä¶");
      }
    }

    function groupEnsurePeer(peerId){
      if(groupPCs.has(peerId)) return groupPCs.get(peerId);

      const pc = new RTCPeerConnection({ iceServers: ICE_SERVERS });
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      pc.ontrack = (ev)=>{
        const [stream] = ev.streams;
        groupStreams.set(peerId, stream);
        const slot = groupSlotByPeer.get(peerId) ?? 0;
        attachRemoteToSlot(slot, stream);
        showSearchingOverlay(slot, false);
        if(slot===1 && isMobile()){
          mobileMini.classList.add("show");
        }
        setStatus(mode === "cupid" ? "Cupido" : "‚Äî", "Conectado", "Conectado ‚úÖ");
      };

      pc.onicecandidate = (ev)=>{
        if(ev.candidate && groupSessionId){
          wsSend({ type:"group-ice", group:true, sessionId: groupSessionId, to: peerId, candidate: ev.candidate });
        }
      };

      groupPCs.set(peerId, pc);

      // Determin√≠stico: el id menor ofrece
      const iOffer = (String(myId) < String(peerId));
      if(iOffer){
        pc.createOffer()
          .then(offer => pc.setLocalDescription(offer).then(()=>offer))
          .then(offer => {
            if(groupSessionId){
              wsSend({ type:"group-offer", group:true, sessionId: groupSessionId, to: peerId, sdp: offer.sdp });
            }
          })
          .catch(err => console.warn("group offer err", err));
      }

      return pc;
    }

    function handleGroupInit(data){
      const sid = data.sessionId;
      const peers = Array.isArray(data.peers) ? data.peers : [];

      // If new session, hard reset
      if(groupSessionId && sid && sid !== groupSessionId){
        cleanupGroup(true);
      }

      groupSessionId = sid || groupSessionId || ("sid_" + Date.now());
      groupActive = true;

      // Mapping slots by order
      groupSlotByPeer.clear();
      peers.forEach((p, idx)=>{
        if(p && p.id) groupSlotByPeer.set(p.id, idx);
      });

      // Ensure both slots show searching until video arrives
      updateLayoutForMode();
      showSearchingOverlay(0, true, mode==="cupid" ? "Conectando (Cupido)‚Ä¶" : "Conectando‚Ä¶");
      if(mode==="cupid") showSearchingOverlay(1, true, "Esperando segunda persona‚Ä¶");

      // create pcs for known peers
      peers.forEach(p=>{
        if(p && p.id) groupEnsurePeer(p.id);
      });

      setStatus("Cupido", "Conectando", "Armando llamada‚Ä¶");
    }

    function handleGroupAdd(data){
      if(!data || data.sessionId !== groupSessionId) return;
      const peer = data.peer;
      const peerId = peer?.id;
      const slot = Number.isFinite(data.slot) ? data.slot : 1;
      if(!peerId) return;

      groupSlotByPeer.set(peerId, slot);
      showSearchingOverlay(slot, true, "Conectando‚Ä¶");
      groupEnsurePeer(peerId);
    }

    function handleGroupRemove(data){
      if(!data || data.sessionId !== groupSessionId) return;
      const peerId = data.peerId;
      const slot = Number.isFinite(data.slot) ? data.slot : (groupSlotByPeer.get(peerId) ?? 1);

      // close pc
      const pc = groupPCs.get(peerId);
      if(pc){
        try{ pc.ontrack = null; pc.onicecandidate = null; pc.close(); }catch{}
      }
      groupPCs.delete(peerId);
      groupStreams.delete(peerId);
      groupSlotByPeer.delete(peerId);

      clearRemoteSlot(slot);
      showSearchingOverlay(slot, true, "Buscando reemplazo‚Ä¶");
      setStatus("Cupido", "Buscando", "Alguien se fue‚Ä¶ buscando reemplazo.");
    }

    function handleGroupClose(data){
      // Always cleanup
      cleanupGroup(true);

      // If still in cupid mode, go back to waiting overlays
      if(mode === "cupid"){
        updateLayoutForMode();
        showSearchingOverlay(0, true, cupidRole==="host" ? "Esperando gente (Cupido)‚Ä¶" : "Esperando a Kristoff‚Ä¶");
        showSearchingOverlay(1, true, "Esperando otra persona‚Ä¶");
        setStatus("Cupido", "Esperando", cupidRole==="host" ? "Host activo. Esperando participantes‚Ä¶" : "En cola de Cupido‚Ä¶");
      }
    }

    async function handleGroupSignal(msg){
      if(msg.sessionId !== groupSessionId) return;
      const from = msg.from;
      if(!from) return;

      const pc = groupPCs.get(from) || groupEnsurePeer(from);

      if(msg.type === "group-offer"){
        await pc.setRemoteDescription({ type:"offer", sdp: msg.sdp });
        const ans = await pc.createAnswer();
        await pc.setLocalDescription(ans);
        wsSend({ type:"group-answer", group:true, sessionId: groupSessionId, to: from, sdp: ans.sdp });
      }else if(msg.type === "group-answer"){
        await pc.setRemoteDescription({ type:"answer", sdp: msg.sdp });
      }else if(msg.type === "group-ice"){
        try{ await pc.addIceCandidate(msg.candidate); }catch{}
      }
    }

    /*****************
     * Cupido mode
     *****************/
    async function startCupidAsGuest(){
      mode = "cupid";
      cupidRole = "guest";
      updateLayoutForMode();
      cleanupSolo();
      cleanupGroup(true);

      await ensureWS();
      await ensureMedia();
      attachLocalStream();

      setStatus("Cupido", "En cola", "Esperando a Kristoff‚Ä¶");
      showSearchingOverlay(0, true, "Esperando a Kristoff‚Ä¶");
      showSearchingOverlay(1, true, "Esperando otra persona‚Ä¶");
      if(isMobile()) mobileMini.classList.add("show");

      wsSend({
        type:"cupid-join",
        displayName: profile.name || currentUser?.displayName || "Usuario",
        gender: profile.gender || null,
        age: profile.age || null
      });
    }

    async function startCupidAsHost(){
      mode = "cupid";
      cupidRole = "host";
      updateLayoutForMode();
      cleanupSolo();
      cleanupGroup(true);

      await ensureWS();
      await ensureMedia();
      attachLocalStream();

      setStatus("Cupido", "Host", "Host activo. Esperando participantes‚Ä¶");
      showSearchingOverlay(0, true, "Esperando participantes‚Ä¶");
      showSearchingOverlay(1, true, "Esperando participantes‚Ä¶");
      if(isMobile()) mobileMini.classList.add("show");

      wsSend({
        type:"cupid-host-on",
        displayName: profile.name || currentUser?.displayName || "Kristoff"
      });
    }

    /*****************
     * Stop / Next
     *****************/
    async function stopAll(reason="stop"){
      // Tell server we leave whichever mode
      if(wsOpen){
        if(mode === "solo"){
          wsSend({ type:"leave" });
        }else if(mode === "cupid"){
          if(cupidRole === "host") wsSend({ type:"cupid-host-off" });
          else wsSend({ type:"cupid-leave" });
        }else{
          wsSend({ type:"leave" });
        }
      }

      // cleanup
      cleanupSolo();
      cleanupGroup(true);
      mode = null;
      cupidRole = null;
      setStatus("‚Äî", "‚Äî", "");

      // Keep local stream, but you can stop tracks if you want:
      // if(localStream){ localStream.getTracks().forEach(t=>t.stop()); localStream=null; }

      showPage(pageMode);
      updateLayoutForMode();
      return;
    }

    async function nextAction(){
      if(!wsOpen) return;

      if(mode === "solo"){
        // leave current and find again
        wsSend({ type:"leave" });
        cleanupSolo();
        setStatus("Solo", "Buscando", "Buscando alguien nuevo‚Ä¶");
        showSearchingOverlay(0, true, "Buscando alguien‚Ä¶");
        setTimeout(()=>{
          wsSend({
            type:"find",
            displayName: profile.name || currentUser?.displayName || "Usuario",
            gender: profile.gender || null,
            age: profile.age || null
          });
        }, 120);
      }else if(mode === "cupid"){
        if(cupidRole === "host"){
          wsSend({ type:"cupid-next" });
          showToast("Siguiente (cambiando personas)...");
          // Keep overlays
          showSearchingOverlay(0, true, "Cambiando‚Ä¶");
          showSearchingOverlay(1, true, "Cambiando‚Ä¶");
        }else{
          wsSend({ type:"cupid-skip" });
          showToast("Siguiente (volviendo a la cola)‚Ä¶");
          handleGroupClose({});
        }
      }
    }

    btnStop.onclick = ()=>stopAll("stop");
    btnBackModes.onclick = ()=>stopAll("back");
    btnNext.onclick = ()=>nextAction();

    // Fake skip: Enter key (solo + admin)
    window.addEventListener("keydown", (e)=>{
      if(e.key === "Enter" && IS_ADMIN && mode === "solo"){
        wsSend({ type:"fake-skip-toggle" });
      }
    });

    /*****************
     * Mode cards
     *****************/
    cardSolo.onclick = async ()=>{
      // ensure profile exists (guest might have it already)
      if(!profile.gender || !profile.name || !profile.age){
        // load from localStorage in case
        try{
          const raw = localStorage.getItem("ttv_profile");
          if(raw){
            const p = JSON.parse(raw);
            profile.gender = p.gender || profile.gender;
            profile.name = p.name || profile.name;
            profile.age = p.age || profile.age;
          }
        }catch{}
      }
      showPage(pageChat);
      await startSolo();
    };

    cardCupid.onclick = async ()=>{
      // same profile load
      if(!profile.gender || !profile.name || !profile.age){
        try{
          const raw = localStorage.getItem("ttv_profile");
          if(raw){
            const p = JSON.parse(raw);
            profile.gender = p.gender || profile.gender;
            profile.name = p.name || profile.name;
            profile.age = p.age || profile.age;
          }
        }catch{}
      }
      showPage(pageChat);
      if(IS_ADMIN){
        await startCupidAsHost();
      }else{
        await startCupidAsGuest();
      }
    };

    /*****************
     * WS message handling
     *****************/
    function handleWS(msg){
      switch(msg.type){
        case "welcome":{
          myId = msg.id;
          break;
        }
        case "role":{
          IS_ADMIN = !!msg.isAdmin;
          IS_PRO = !!msg.isPro;
          setAdminChip(IS_ADMIN);
          if(IS_ADMIN){
            showToast("Admin activo ‚úÖ");
          }
          // close modal if open
          if(!modalKristoff.classList.contains("hidden")){
            if(IS_ADMIN){
              adminLoginHint.textContent = "Listo ‚úÖ";
              setTimeout(closeKristoffModal, 450);
            }else{
              adminLoginHint.textContent = "No autorizado.";
            }
          }
          break;
        }
        case "kristoff-login-result":{
          if(msg.ok){
            adminLoginHint.textContent = "Listo ‚úÖ";
            showToast("Bienvenido Kristoff ‚úÖ");
            setTimeout(closeKristoffModal, 450);
          }else{
            adminLoginHint.textContent = msg.reason || "Contrase√±a/email incorrectos.";
            showToast("Login admin fall√≥.");
          }
          break;
        }

        // SOLO
        case "matched":{
          if(mode !== "solo") return;
          handleSoloMatched(msg).catch(err=>console.error(err));
          break;
        }
        case "offer":{
          if(mode !== "solo") return;
          handleSoloOffer(msg.sdp).catch(err=>console.error(err));
          break;
        }
        case "answer":{
          if(mode !== "solo") return;
          handleSoloAnswer(msg.sdp).catch(err=>console.error(err));
          break;
        }
        case "ice":{
          if(mode !== "solo") return;
          handleSoloIce(msg.candidate).catch(()=>{});
          break;
        }
        case "peer-left":{
          if(mode !== "solo") return;
          showToast("La otra persona se fue.");
          cleanupSolo();
          setStatus("Solo", "Buscando", "Buscando alguien nuevo‚Ä¶");
          wsSend({
            type:"find",
            displayName: profile.name || currentUser?.displayName || "Usuario",
            gender: profile.gender || null,
            age: profile.age || null
          });
          break;
        }
        case "fake-skip":{
          // Visual simple: mostrar overlay "Saltando..." en el remoto
          if(mode !== "solo") return;
          if(msg.on){
            showSearchingOverlay(0, true, "Saltando‚Ä¶");
            setStatus("Solo", "Saltando", "Fake skip activado‚Ä¶");
          }else{
            showSearchingOverlay(0, false);
            setStatus("Solo", "Conectado", "Conectado ‚úÖ");
          }
          break;
        }

        // GROUP / CUPID
        case "group-init":{
          if(mode !== "cupid") return;
          handleGroupInit(msg);
          break;
        }
        case "group-add":{
          if(mode !== "cupid") return;
          handleGroupAdd(msg);
          break;
        }
        case "group-remove":{
          if(mode !== "cupid") return;
          handleGroupRemove(msg);
          break;
        }
        case "group-close":{
          if(mode !== "cupid") return;
          handleGroupClose(msg);
          break;
        }
        case "group-offer":
        case "group-answer":
        case "group-ice":{
          if(mode !== "cupid") return;
          handleGroupSignal(msg).catch(err=>console.error(err));
          break;
        }

        default:
          // console.log("WS", msg);
          break;
      }
    }

    /*****************
     * First page setup
     *****************/
    // If no firebase user and not guest, landing stays.
    if(!auth.currentUser){
      showPage(pageLanding);
    }

  </script>
</body>
</html>